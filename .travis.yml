language: node_js
node: 14
git:
  depth: 3
cache: yarn
before_script:
  - yarn workspace @trulyacerbic/ttt-apis build
jobs:
  - stage: test
    name: Testing gmaster
    script: yarn workspace gmaster test --runInBand

  - stage: test
    name: Testing ghost
    script: yarn workspace ghost test --runInBand

  - stage: deploy
    name: Deploying Docker containers
    if: branch = master
    cache: false
    install: skip
    services:
      - docker
    addons:
      ssh_known_hosts: $DOCKER_DEPLOY_HOST
    before_script: skip
    script: if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then bash ./deployment/travis_build_docker.sh; fi
    before_deploy:
      - echo "$DOCKER_DEPLOY_RSA_KEY_BASE64" | base64 -d > /tmp/deploy_rsa
      - eval "$(ssh-agent -s)"
      - chmod 600 /tmp/deploy_rsa
      - ssh-add /tmp/deploy_rsa
    deploy:
      provider: script
      skip_cleanup: true
      script: bash ./deployment/travis_deploy_docker.sh

  - stage: deploy
    name: Deploying Next.js Client code
    install: skip
    before_script: npm i -g now
    script:
      - bash ./deployment/travis_deploy_client.sh
